{% extends "base.html" %}

{% import "macros/macros.html" as post_macros %}

{% block main_content %}
    {% set publications_data = load_data(path="data/publications.yml") %}
    
    <!-- JSON-LD Structured Data for Publications -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Filippo Guerranti",
      "jobTitle": "PhD Researcher",
      "affiliation": {
        "@type": "Organization",
        "name": "Technical University of Munich",
        "url": "https://www.tum.de"
      },
      "url": "https://filippoguerranti.com",
      "sameAs": [
        "https://scholar.google.com/citations?user=uekwkvYAAAAJ",
        "https://github.com/guerrantif",
        "https://www.linkedin.com/in/filippoguerranti/",
        "https://x.com/guerrantif"
      ],
      "hasOccupation": {
        "@type": "Occupation",
        "name": "Researcher",
        "occupationLocation": {
          "@type": "Place",
          "name": "Munich, Germany"
        },
        "skills": "Machine Learning for Graphs and Structured Data"
      },
      "scholar": [
        {% for pub in publications_data.publications %}
        {
          "@type": "ScholarlyArticle",
          "headline": "{{ pub.title }}",
          "author": [
            {% for author_key in pub.authors -%}
              {%- set clean_key = author_key | replace(from="*", to="") -%}
              {%- if publications_data.authors[clean_key] -%}
                {%- set author = publications_data.authors[clean_key] -%}
                {
                  "@type": "Person",
                  "name": "{{ author.name }}"
                  {%- if author.website -%}, "url": "{{ author.website }}"{%- endif -%}
                }
              {%- else -%}
                {
                  "@type": "Person", 
                  "name": "{{ author_key | replace(from="*", to="") }}"
                }
              {%- endif -%}
              {%- if not loop.last %},{% endif -%}
            {% endfor %}
          ],
          "datePublished": "{{ pub.year }}",
          "publisher": {
            "@type": "Organization",
            "name": "{{ pub.venue }}"
          }
          {%- if pub.links -%}
          , "url": "{% for link_type, url in pub.links %}{% if loop.first %}{{ url }}{% endif %}{% endfor %}"
          {%- endif -%}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }
    </script>
    
    {{ post_macros::page_header(title=section.title) }}

    <main>
        
        {% if publications_data.publications %}
            <div class="publications-list">
                <!-- Selected Papers Section -->
                {% set selected_pubs = publications_data.publications | filter(attribute="selected") | sort(attribute="year") | reverse %}
                {% if selected_pubs %}
                    <div class="section">
                        <h1 class="section-header">selected</h1>
                        {% for pub in selected_pubs %}
                            <div class="publication-item">
                                <div class="publication-title">{{ pub.title }}</div>
                                
                                <div class="publication-authors">
                                    {% for author_key in pub.authors -%}
                                        {%- set clean_key = author_key | replace(from="*", to="") -%}
                                        {%- if publications_data.authors[clean_key] -%}
                                            {%- set author = publications_data.authors[clean_key] -%}
                                            {%- if clean_key == "FG" -%}
                                                <strong>{{ author.name }}</strong>
                                            {%- elif author.website -%}
                                                <a href="{{ author.website }}" target="_blank" rel="noopener noreferrer">{{ author.name }}</a>
                                            {%- else -%}
                                                {{ author.name }}
                                            {%- endif -%}
                                            {%- if author_key is containing("*") -%}*{%- endif -%}
                                        {%- else -%}
                                            {{ author_key }}
                                        {%- endif -%}
                                        {%- if not loop.last %}, {% endif -%}
                                    {% endfor %}
                                </div>
                                
                                <div class="publication-venue">
                                    <em>{{ pub.venue }}</em>, {{ pub.year }}
                                </div>
                                
                                {% if pub.links or pub.bibtex %}
                                    <div class="publication-links">
                                        {% if pub.links %}
                                            {% for link_type, url in pub.links %}
                                                <a href="{{ url }}" class="publication-link" target="_blank" rel="noopener noreferrer">
                                                    [{{ link_type | lower }}]
                                                </a>
                                            {% endfor %}
                                        {% endif %}
                                        
                                        {% if pub.bibtex %}
                                            <button class="publication-link bibtex-copy" onclick="copyBibtex('{{ pub.id }}')">
                                                [bibtex]
                                            </button>
                                            <textarea id="bibtex-{{ pub.id }}" style="position: absolute; left: -9999px;">{{ pub.bibtex }}</textarea>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Rest Section -->
                <div class="section">
                    <h1 class="section-header">rest</h1>
                    {% for pub in publications_data.publications | sort(attribute="year") | reverse %}
                        {% if not pub.selected %}
                        <div class="publication-item">
                            <div class="publication-title">{{ pub.title }}</div>
                            
                            <div class="publication-authors">
                                {% for author_key in pub.authors -%}
                                    {%- set clean_key = author_key | replace(from="*", to="") -%}
                                    {%- if publications_data.authors[clean_key] -%}
                                        {%- set author = publications_data.authors[clean_key] -%}
                                        {%- if clean_key == "FG" -%}
                                            <strong>{{ author.name }}</strong>
                                        {%- elif author.website -%}
                                            <a href="{{ author.website }}" target="_blank" rel="noopener noreferrer">{{ author.name }}</a>
                                        {%- else -%}
                                            {{ author.name }}
                                        {%- endif -%}
                                        {%- if author_key is containing("*") -%}*{%- endif -%}
                                    {%- else -%}
                                        {{ author_key }}
                                    {%- endif -%}
                                    {%- if not loop.last %}, {% endif -%}
                                {% endfor %}
                            </div>
                            
                            <div class="publication-venue">
                                <em>{{ pub.venue }}</em>, {{ pub.year }}
                            </div>
                            
                            {% if pub.links or pub.bibtex %}
                                <div class="publication-links">
                                    {% if pub.links %}
                                        {% for link_type, url in pub.links %}
                                            <a href="{{ url }}" class="publication-link" target="_blank" rel="noopener noreferrer">
                                                [{{ link_type | lower }}]
                                            </a>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if pub.bibtex %}
                                        <button class="publication-link bibtex-copy" onclick="copyBibtex('{{ pub.id }}')">
                                            [bibtex]
                                        </button>
                                        <textarea id="bibtex-{{ pub.id }}" style="position: absolute; left: -9999px;">{{ pub.bibtex }}</textarea>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <p>No publications found.</p>
        {% endif %}
    </main>


    <script>
    function copyBibtex(pubId) {
        const textarea = document.getElementById('bibtex-' + pubId);
        const button = event.target;
        
        // Copy to clipboard
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // Visual feedback
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
    }
    </script>
{% endblock main_content %}